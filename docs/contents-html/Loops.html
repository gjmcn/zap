<h2>Loops</h2>
<hr>
<blockquote>
<p>Operators for working with iterables (including loop operators, but also see e.g. <a href="?Reduce">Reduce</a>, <a href="?Filter-and-Group">Filter and Group</a>, <a href="?Order-and-Bin">Order and Bin</a>, <a href="?Backticks">Backticks</a> and <a href="?Tabular-Data">Tabular Data</a>) treat empty array elements as normal elements (with value <code>undefined</code>). In contrast, some array methods ignore empty elements.</p>
</blockquote>
<hr>
<h4 id="each"><code>each</code></h4>
<p>Loop over an iterable.</p>
<p>The first operand of <code>each</code> is the iterable; the final operand is the loop <a href="?Syntax#body-operands">body</a>. Between these, we can provide optional <em>loop parameters</em> for the current value, current index and the iterable:</p>
<pre><code><span class="zap-comment">// body in parentheses, prints: 4 5 6</span>
<span class="zap-operator">@</span> <span class="zap-number">4</span> <span class="zap-number">5</span> <span class="zap-number">6</span> <span class="zap-keyword">each</span> <span class="zap-identifier">x</span> <span class="zap-punctuation">(</span><span class="zap-keyword">print</span> <span class="zap-identifier">x</span><span class="zap-punctuation">)</span>

<span class="zap-comment">// body in indented block, prints: 'a0' 'b1' 'c2'</span>
<span class="zap-string">'abc'</span> <span class="zap-keyword">each</span> <span class="zap-identifier">s</span> <span class="zap-identifier">i</span>
    <span class="zap-identifier">s</span> <span class="zap-operator">+</span> <span class="zap-identifier">i</span> <span class="zap-keyword">print</span>
</code></pre>
<p><code>each</code> returns the iterable.</p>
<p>Use <code>stop</code> to exit a loop <em>at the end of the current step</em>:</p>
<pre><code><span class="zap-comment">// prints 4 5 6</span>
<span class="zap-operator">@</span> <span class="zap-number">4</span> <span class="zap-number">5</span> <span class="zap-number">6</span> <span class="zap-number">7</span> <span class="zap-number">8</span> <span class="zap-keyword">each</span> <span class="zap-identifier">x</span>
    <span class="zap-keyword">print</span> <span class="zap-identifier">x</span>
    <span class="zap-keyword">if</span> <span class="zap-punctuation">(</span><span class="zap-identifier">x</span> <span class="zap-operator">==</span> <span class="zap-number">6</span><span class="zap-punctuation">)</span>
        <span class="zap-keyword">stop</span>

<span class="zap-comment">// prints 4 5 6</span>
<span class="zap-operator">@</span> <span class="zap-number">4</span> <span class="zap-number">5</span> <span class="zap-number">6</span> <span class="zap-number">7</span> <span class="zap-number">8</span> <span class="zap-keyword">each</span> <span class="zap-identifier">x</span>
    <span class="zap-keyword">if</span> <span class="zap-punctuation">(</span><span class="zap-identifier">x</span> <span class="zap-operator">==</span> <span class="zap-number">6</span><span class="zap-punctuation">)</span>
        <span class="zap-keyword">stop</span>
    <span class="zap-keyword">print</span> <span class="zap-identifier">x</span>
</code></pre>
<hr>
<h4 id="map"><code>map</code></h4>
<p>As <a href="#each"><code>each</code></a>, but <code>map</code> collects the value of the body (the last expression evaluated) at each step in an array:</p>
<pre><code><span class="zap-operator">@</span> <span class="zap-number">4</span> <span class="zap-number">5</span> <span class="zap-number">6</span> <span class="zap-keyword">map</span> <span class="zap-identifier">x</span> <span class="zap-punctuation">(</span><span class="zap-identifier">x</span> <span class="zap-operator">+</span> <span class="zap-number">10</span><span class="zap-punctuation">)</span>   <span class="zap-comment">// [14, 15, 16]</span>

<span class="zap-comment">// returns [14, 15, 16]</span>
<span class="zap-operator">@</span> <span class="zap-number">4</span> <span class="zap-number">5</span> <span class="zap-number">6</span> <span class="zap-number">7</span> <span class="zap-number">8</span> <span class="zap-keyword">map</span> <span class="zap-identifier">x</span> <span class="zap-identifier">i</span>
    <span class="zap-keyword">if</span> <span class="zap-punctuation">(</span><span class="zap-identifier">i</span> <span class="zap-operator">==</span> <span class="zap-number">2</span><span class="zap-punctuation">)</span>
        <span class="zap-keyword">stop</span>
    <span class="zap-identifier">x</span> <span class="zap-operator">+</span> <span class="zap-number">10</span>
</code></pre>
<hr>
<h4 id="do"><code>do</code></h4>
<p>Basic loop.</p>
<p>The final operand of <code>do</code> is the loop <a href="?Syntax#body-operands">body</a>. The optional operands are the maximum number of steps and the current index:</p>
<pre><code><span class="zap-comment">// prints 0 1 2 3 4</span>
<span class="zap-number">5</span> <span class="zap-keyword">do</span> <span class="zap-identifier">i</span>
    <span class="zap-keyword">print</span> <span class="zap-identifier">i</span>
</code></pre>
<p><code>do</code> returns <code>undefined</code>.</p>
<p>Use <code>stop</code> to exit a loop <em>at the end of the current step</em>.</p>
<p>Use <code>Infinity</code> as the maximum number of steps when there is no actual maximum, but the index parameter is required:</p>
<pre><code><span class="zap-comment">// prints 0 1 2 3 4</span>
<span class="zap-literal">Infinity</span> <span class="zap-keyword">do</span> <span class="zap-identifier">i</span>
    <span class="zap-keyword">print</span> <span class="zap-identifier">i</span>
    <span class="zap-keyword">if</span> <span class="zap-punctuation">(</span><span class="zap-identifier">i</span> <span class="zap-operator">==</span> <span class="zap-number">4</span><span class="zap-punctuation">)</span>
        <span class="zap-keyword">stop</span>
</code></pre>
<p>If only the loop body is given, the maximum number of steps defaults to <code>Infinity</code>:</p>
<pre><code><span class="zap-identifier">x</span> <span class="zap-operator">=</span> <span class="zap-number">1</span>
<span class="zap-keyword">do</span>
    <span class="zap-identifier">x</span> <span class="zap-operator">*=</span> <span class="zap-number">2</span>
    <span class="zap-keyword">if</span> <span class="zap-punctuation">(</span><span class="zap-identifier">x</span> <span class="zap-operator">&gt;</span> <span class="zap-number">20</span><span class="zap-punctuation">)</span>
        <span class="zap-keyword">stop</span>
<span class="zap-identifier">x</span>   <span class="zap-comment">// 32</span>
</code></pre>
<p>Even though <code>stop</code> only exits a loop at the end of the current step, we can use <code>if</code> with an <code>else</code> branch to effectively exit a loop at the point where <code>stop</code> is encountered:</p>
<pre><code><span class="zap-identifier">x</span> <span class="zap-operator">=</span> <span class="zap-number">25</span>
<span class="zap-keyword">do</span>
    <span class="zap-keyword">if</span> <span class="zap-punctuation">(</span><span class="zap-identifier">x</span> <span class="zap-operator">&gt;</span> <span class="zap-number">20</span><span class="zap-punctuation">)</span>
        <span class="zap-keyword">stop</span>
    <span class="zap-punctuation">|</span> <span class="zap-literal">else</span>
        <span class="zap-identifier">x</span> <span class="zap-operator">*=</span> <span class="zap-number">2</span>
<span class="zap-identifier">x</span>   <span class="zap-comment">// 25</span>
</code></pre>
<p>The maximum number of steps is fixed before the loop starts:</p>
<pre><code><span class="zap-comment">// prints 0 1 2 3 4</span>
<span class="zap-identifier">n</span> <span class="zap-operator">=</span> <span class="zap-number">5</span>
<span class="zap-identifier">n</span> <span class="zap-keyword">do</span> <span class="zap-identifier">i</span>
    <span class="zap-identifier">n</span> <span class="zap-operator">+=</span> <span class="zap-number">10</span>
    <span class="zap-keyword">print</span> <span class="zap-identifier">i</span>
</code></pre>
<hr>
<h4 id="async-loops"><code>asyncEach</code>, <code>asyncMap</code>, <code>asyncDo</code></h4>
<p>Asynchronous versions of <a href="#each"><code>each</code></a>, <a href="#map"><code>map</code></a> and <a href="#do"><code>do</code></a>.</p>
<p>These operators return a promise that resolves to:</p>
<ul>
<li><code>asyncEach</code>: the iterable</li>
<li><code>asyncMap</code>: a new array</li>
<li><code>asyncDo</code>: <code>undefined</code></li>
</ul>
<p><code>await</code> can be used in the body of an asynchronous loop:</p>
<pre><code><span class="zap-comment">// wait 1000 ms, print 5, wait 1000 ms, print 6 </span>
<span class="zap-operator">@</span> <span class="zap-number">5</span> <span class="zap-number">6</span> <span class="zap-keyword">asyncEach</span> <span class="zap-identifier">x</span>
    <span class="zap-keyword">period</span> <span class="zap-number">1000</span> <span class="zap-keyword">await</span>
    <span class="zap-keyword">print</span> <span class="zap-identifier">x</span>
</code></pre>
<p>In the following example, we <code>await</code> the loop itself:</p>
<pre><code><span class="zap-comment">// wait 1000 ms, print 5, wait 1000 ms, print 6, print 'done'</span>
<span class="zap-keyword">asyncScope</span>
    <span class="zap-operator">@</span> <span class="zap-number">5</span> <span class="zap-number">6</span> <span class="zap-keyword">asyncEach</span> <span class="zap-identifier">x</span>
        <span class="zap-keyword">period</span> <span class="zap-number">1000</span> <span class="zap-keyword">await</span>
        <span class="zap-keyword">print</span> <span class="zap-identifier">x</span>
    <span class="zap-punctuation">|</span> <span class="zap-keyword">await</span>
    <span class="zap-keyword">print</span> <span class="zap-string">'done'</span>
</code></pre>
<hr>
<h4 id="loop-variables">Loop Parameters and Variables</h4>
<p>Loop parameters, and variables created inside the loop body are local to a single step of the loop. Assigning a new value to a parameter/variable will not affect its value at the next step, nor will it affect the behavior of the loop.</p>
<hr>
<h4 id="yield-in-loops">Using <code>yield</code> and <code>yieldFrom</code></h4>
<p>If <code>yield</code> or <code>yieldFrom</code> is used in the body of an <a href="#each"><code>each</code></a>, <a href="#do"><code>do</code></a>, <a href="#async-loops"><code>asyncEach</code></a> or <a href="#async-loops"><code>asyncDo</code></a> loop, the operator returns a generator (or asynchronous generator):</p>
<pre><code><span class="zap-identifier">g</span> <span class="zap-operator">=</span> <span class="zap-number">5</span> <span class="zap-keyword">do</span> <span class="zap-identifier">i</span> <span class="zap-punctuation">(</span><span class="zap-keyword">yield</span> <span class="zap-identifier">i</span><span class="zap-punctuation">)</span>   <span class="zap-comment">// generator</span>
<span class="zap-identifier">g</span> <span class="zap-keyword">array</span>                <span class="zap-comment">// [0, 1, 2, 3, 4]</span>

<span class="zap-operator">@</span> <span class="zap-number">5</span> <span class="zap-number">6</span> <span class="zap-number">7</span> <span class="zap-keyword">each</span> <span class="zap-identifier">x</span>
    <span class="zap-keyword">yield</span> <span class="zap-identifier">x</span>
    <span class="zap-keyword">yieldFrom</span> <span class="zap-string">'ab'</span>
<span class="zap-punctuation">|</span> <span class="zap-keyword">array</span>                <span class="zap-comment">// [5, 'a', 'b', 6, 'a', 'b', 7, 'a', 'b']</span>
</code></pre>
<blockquote>
<p><code>yield</code> and <code>yieldFrom</code> turn a loop into a generator function (which is automatically called to give the returned generator) so the loop will have its own <code>this</code>, <code>arguments</code>, <code>super</code> and <code>new :target</code>.</p>
</blockquote>

<br><br><br>